<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>DIY电子女友小智 | 首页</title><meta name="keywords" content="AI,ESP32,语音助手"><meta name="author" content="周言志"><meta name="copyright" content="周言志"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="DIY电子女友小智"><meta name="application-name" content="DIY电子女友小智"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="DIY电子女友小智"><meta property="og:url" content="http://example.com/2025/04/12/25-4-12ai%E5%B0%8F%E6%99%BA/index.html"><meta property="og:site_name" content="首页"><meta property="og:description" content="简介此博客为一篇针对初学者的详细教程，涵盖小智 AI 机器人的原理、硬件准备、软件环境搭建、代码实现、云端部署以及优化扩展。文章结合了现有的网络资源，取长补短，确保内容易于理解和操作。 教程目标本教程将指导初学者使用 ESP32 微控制器开发一个简单的语音对话机器人“小智”。我们将介绍所需的基础原理"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2025/04/13/67fa94a426f38.png"><meta property="article:author" content="周言志"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2025/04/13/67fa94a426f38.png"><meta name="description" content="简介此博客为一篇针对初学者的详细教程，涵盖小智 AI 机器人的原理、硬件准备、软件环境搭建、代码实现、云端部署以及优化扩展。文章结合了现有的网络资源，取长补短，确保内容易于理解和操作。 教程目标本教程将指导初学者使用 ESP32 微控制器开发一个简单的语音对话机器人“小智”。我们将介绍所需的基础原理"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2025/04/12/25-4-12ai%E5%B0%8F%E6%99%BA/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: undefined,
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://yuhaozhe-twikoo.hf.space',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: 周言志","link":"链接: ","source":"来源: 首页","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '首页',
  title: 'DIY电子女友小智',
  postAI: '',
  pageFillDescription: '简介, 教程目标, 1. 基础原理, ESP32 架构及其在 AI 领域的应用, 语音唤醒模块（ESP-SR）的工作原理, 流式对话的概念及 WebSocketx2FUDP 传输机制, WebSocket 通信, UDP 传输, 2. 硬件准备, ESP32-S3 开发板（带有 PSRAM）, 麦克风, 扬声器和音频放大器（可选）, 显示屏（OLEDx2FLCD可选）, 其他配件, 选购建议, 3. 软件环境搭建, 安装 ESP-IDF 开发框架, 配置 VSCodex2FCursor 开发环境, 安装所需库和工具, 4. 代码实现, 4.1 初始化语音唤醒功能, 4.2 处理语音输入并上传至大模型, 音频采集, 数据上传, 4.3 与云端模型的交互并返回文本, 5. 云端部署, 连接大语言模型 (DeepSeekx2FQwen 等), 调用语音识别 API, 服务器端搭建 AI 服务, 6. 优化与扩展, 提升本地计算能力, 增强离线功能, 显示屏交互扩展, 语音合成输出, 其他扩展创意, 结语, 参考文献简介此博客为一篇针对初学者的详细教程涵盖小智机器人的原理硬件准备软件环境搭建代码实现云端部署以及优化扩展文章结合了现有的网络资源取长补短确保内容易于理解和操作教程目标本教程将指导初学者使用微控制器开发一个简单的语音对话机器人小智我们将介绍所需的基础原理硬件准备软件环境搭建以及如何编写代码实现语音唤醒和与云端大模型的对接通过本教程即使没有深厚的或嵌入式经验也可以一步步制作出一个能听懂唤醒词并与人对话的简易机器人本教程提供详细的操作步骤代码示例和图示帮助您轻松上手基础原理架构及其在领域的应用是一款集成和蓝牙的双核微控制器具有较高的主频和丰富的外设接口适合物联网和嵌入式应用特别是新版的芯片不仅运行频率高达还内置了向量加速指令有时称为指令并支持高速从而可以在一定程度上加速神经网络推理以乐鑫语音开发框架为例系统了解嵌入式设备的语音唤醒和语音识别在领域常用于边缘设备执行一些轻量级的本地任务如语音关键词检测简单的图像识别等或充当连接云端服务的桥梁由于资源有限无法独立运行大型深度学习模型但它可以负责前端的数据采集和初步处理如音频处理然后将数据传输给云端或本地服务器上的强大模型进行复杂计算再将结果返回设备这样的架构充分利用了的实时控制能力和云端大模型的强大推理能力语音唤醒模块的工作原理乐鑫官方提供了语音识别框架包含唤醒词引擎命令词识别等组件以乐鑫语音开发框架为例系统了解嵌入式设备的语音唤醒和语音识别其中唤醒词功能用于在设备待机时持续监听音频流当检测到特定的唤醒词时触发设备进入对话识别状态例如我们可以将小智小智设定为唤醒词当运行模型时它会不断从麦克风录制音频并计算梅尔频谱倒谱系数等特征然后通过一个针对优化的神经网络算法对特征进行分类一旦检测到训练好的关键词序列就输出唤醒信号唤醒设备进入语音交互状态这种本地唤醒机制即使在有环境噪声的情况下也能保持较高的准确率官方数据显示在噪声环境下识别率不低于默认提供了一些开箱即用的唤醒词模型如或乐鑫开发者也可以定制自己的唤醒词模型工作流程是麦克风采集到的模拟音频经前端处理降噪增益等送入模型进行关键词检测如果未检测到唤醒词设备保持低功耗待机一旦检测到唤醒词设备即进入后续的语音识别或对话流程同时为了节省运算资源在唤醒后通常会暂停以便释放处理后续音频待对话完成后再重新启用监听下一个唤醒词以乐鑫语音开发框架为例系统了解嵌入式设备的语音唤醒和语音识别流式对话的概念及传输机制所谓流式对话是指机器人在唤醒后能够实时地接收和发送数据与用户进行连续的对话交流而非一次性等待用户说完整句子再回复要实现流式对话需要将用户的语音数据边录制边发送到云端的语音识别大模型服务并且及时接收对方返回的回复数据这通常涉及到稳定高效的网络传输机制常用的方式有两种通信是基于的全双工长连接协议非常适合实时数据交换一旦建立连接服务器和客户端都可以随时发送数据而不需要重复握手在本项目中可在启动时就建立一个通向服务器的长连接检测到唤醒词后立即通过该流式发送音频数据到服务器服务器一边接收音频流一边进行语音识别并将部分结果或最终结果通过同一连接发回给得益于保持的长连接数据可以持续快速地往返实现即时的对话体验例如有开发者采用服务器架构通过传输音频实现实时的语音助手传输是基于数据报的传输协议开销小延迟低但不保证可靠送达在一些对实时性要求极高且可以容忍少量数据丢失的场景可以考虑使用将音频帧连续地发送到服务器不过没有内建重发排序机制需要应用层自行处理丢包重传或顺序问题因此对于初学者项目来说方案实现难度略高而且在局域网环境下已经可以提供足够低的延迟和可靠性所以通常推荐使用实现流式语音对话在开发和调试阶段简便可靠打造实时语音应用的开源架构方案生产力的卓越领导者大模型知识库大模型训练智能体开发待项目成熟后再根据需要考虑是否切换更底层的传输方案如等高级方案打造实时语音应用的开源架构方案生产力的卓越领导者大模型知识库大模型训练智能体开发总结来说本项目将利用的本地语音唤醒能力让设备在检测到小智唤醒词后开始录音并流式发送音频到云端通过与服务器上的大语言模型保持对话数据的实时交互当云端返回文本应答后可将其显示在屏幕上或语音播报从而完成一次人机对话循环硬件准备要制作一个语音对话机器人我们需要准备以下硬件组件并确保它们兼容且正确连接开发板带有核心控制器大脑所在建议选择系列开发板因其具备加速指令集和高速可支持语音唤醒等功能以乐鑫语音开发框架为例系统了解嵌入式设备的语音唤醒和语音识别常见选项包括官方的模块带或多合一的语音开发板如系列和等以乐鑫语音开发框架为例系统了解嵌入式设备的语音唤醒和语音识别这些板子自带麦克风阵列音频编解码等硬件方便语音应用开发麦克风用于采集用户语音强烈推荐使用接口的数字麦克风麦克风例如模块数字麦克风可以直接将音频数据以数字信号传给抗干扰能力强音质更好避免使用模拟麦克风加的方法因为自带的精度有限且噪声较大模拟方案音质往往不佳常用的麦克风模块有等它们需要连接的接口引脚等以及电源扬声器和音频放大器可选用于语音播报机器人回复如果希望机器人能说话需要一个小型扬声器如的输出方案可以通过内置输出模拟音频但驱动扬声器需要功率放大器常用方案是使用数字功放模块如将的音频输出转换为扬声器驱动信号该模块接收的数据和时钟输出功率音频信号直接驱动小喇叭如果暂时不需要语音输出也可以先不接扬声器后续通过串口日志或屏幕查看机器人回复的文本显示屏可选用于显示对话内容或机器人表情一个小型显示屏可以显著增强人机交互体验初学者可以选用接口的单色如寸或接口的彩色如寸这些屏幕可以用来显示用户说的内容和机器人生成的回复文字或显示一些图标头像来提示当前状态正在听在想在说等显示屏通过或接口连接到的对应引脚并需要供电后续可以使用图形库如或驱动库来控制显示内容其他配件若使用独立的开发板和模块还需要若干面包板和连接线方便搭建原型电源线和数据线等如果选用的是类似这类集成度高的设备许多组件屏幕麦克风扬声器已经内置无需额外连接以乐鑫语音开发框架为例系统了解嵌入式设备的语音唤醒和语音识别图音频开发板乐鑫官方语音开发套件示例板载双麦克风音频编解码芯片扬声器接口和接口等方便构建语音交互设备以乐鑫语音开发框架为例系统了解嵌入式设备的语音唤醒和语音识别图使用开发板麦克风扬声器搭建语音助手原型的实际连接示例开发板右下通过面包板连接麦克风中间小圆件和扬声器左上黑色喇叭用于采集和播放语音选购建议如果希望尽量减少硬件连接的麻烦可以选择类似或这样的开发套件它们集成了语音所需的大部分硬件开箱即可使用唤醒词和语音功能例如自带触摸屏双麦克风和扬声器只需刷入程序即可成为一个简单语音助手不过这类套件价格相对较高对于学习和制作原型来说使用普通的开发板加上外接麦克风和屏幕也是常用方案性价比更高在购买麦克风模块时要确认其引脚定义与兼容一般接并注意麦克风的指向性灵敏度等参数以满足您的应用如近场对话一般使用全指向麦克风远场则考虑阵列降噪技术扬声器方面小功率扬声器即可满足语音提示功能若追求更大音量可考虑使用有源音箱或更高功率的放大器但要注意供电能力显示屏选型取决于需求和预算初期可以使用廉价的寸显示文字后期可升级为彩屏显示头像或图形界面总之在硬件搭建阶段请按照各模块的规格说明正确连接电路并确保供电稳定开发板通常通过供电确保电脑口或电源适配器有足够的电流供应完成硬件连接后我们就可以着手软件环境的搭建与代码编写了软件环境搭建在开始编程之前需要搭建好的开发环境以及准备云端大模型所需的工具库安装开发框架是乐鑫官方的底层开发框架我们将使用来编写代码控制请根据您的操作系统安装相应版本的建议使用最新版如以便支持和库安装方法如下用户可以使用乐鑫提供的安装包其中集成了编译工具链和环境等一键安装后运行提供的命令行快捷方式进入开发环境用户可通过克隆仓库然后运行脚本安装所需工具链和包安装完成后运行脚本配置环境变量详细步骤可参考乐鑫官方文档但总的来说安装完成后在命令行执行能看到版本信息即表示环境就绪接下来创建一个项目或者使用官方示例作为起点配置开发环境为了提高开发效率我们推荐使用作为主要的代码编辑器并安装乐鑫官方的插件该插件可以方便地菜单配置项目信息一键编译烧录监视串口输出等您可以在的扩展商店搜索并安装然后按照插件指引配置安装路径和环境除此之外您也可以尝试使用最近流行的代码编辑器本质上是的一个改进版本内置了等大型语言模型作为编程助手用写出第一个程序架构师汤师爷博客园使用您可以在编写代码时得到对代码的提示自动补全和错误检查等智能帮助用写出第一个程序架构师汤师爷博客园这对初学者调试语音项目这样的复杂工程非常有益例如当您不知道某个函数如何使用时可以直接在中询问获取帮助当然使用并非必需如果您习惯纯或其他编辑器也完全可以安装所需库和工具本项目除了自带的组件外还可能需要用到一些专门的软件库特别是在云端服务器部分以实现语音识别和大语言模型对话功能在开发电脑或服务器上建议准备好以下工具语音识别模型及这是阿里巴巴达摩院开源的一个多语言语音理解模型支持语音转文本语言识别情感识别等功能阿里的封装采用发布体积更小附带量化模型支持支持从文件进行语音识别相较于其他开源方案在中文等多语言识别上精度很高据称训练了超万小时语音数据效果优于的模型阿里的封装采用发布体积更小附带量化模型支持支持从文件进行语音识别我们可以使用开源社区提供的推理代码或封装好的服务例如上的项目提供了基于的轻量级封装和接口方便我们将部署成一个本地服务阿里的封装采用发布体积更小附带量化模型支持支持从文件进行语音识别请按照该项目说明安装所需依赖如及并下载模型文件然后启动服务用于将音频流转成文本大语言模型为了让机器人更智能地对答我们需要接入一个强大的大语言模型是国内开源的一个系列大模型基于强化学习技术训练性能媲美一些商业模型他们提供了多种版本包括体积较小的蒸馏模型如基于的以及更大的模型其中通义千问是阿里巴巴开源的大模型系列和版本已开源而参数的模型则在阿里云上提供服务您可以根据自身算力选择使用哪种模型如果本地有高性能可以尝试部署左右参数的模型运行如果没有则可以考虑通过在线调用这些模型的推理服务阿里云提供了接口来调用通义千问模型只需注册获取即可使用语镜基于和模型实现与自身声音对话无论本地部署还是云端请先安装好相应的库如用于加载模型或者官方提供的如其他工具音频处理库如或可能用于服务器录音或读取文件用于通信的库如或的库如果您计划实现实时流式传输以及客户端工具如用于调用等如果打算使用作为服务器也需要准备好环境以及相关依赖如用于的库用于调用服务的等配置好以上软件环境后整个开发流程将会是使用在本地编写并烧录端代码同时使用等在电脑上编写服务器端代码并运行模型服务接下来我们就进入代码实现部分看看如何让各部分协同工作代码实现在这一部分我们将编写端的主要代码实现以下功能唤醒词检测音频采集并上传接收并处理云端返回的文本代码将基于编写语言为由于完整代码较长这里拆分讲解关键步骤并提供简化的代码示例初始化语音唤醒功能首先我们需要初始化提供的唤醒词引擎使能麦克风采集和关键词检测假设我们使用和官方库初始化主要包括配置声学前端参数启用模型设置唤醒回调等伪代码示例如下配置声学前端参数默认配置启用唤醒词检测不启用通话模式以免与唤醒冲突指定唤醒词模型名称假设我们有小智模型麦克风通道单通道模式初始化并加载唤醒词模型初始化失败唤醒词引擎加载成功注册唤醒回调当检测到唤醒词时执行上面代码说明使用宏获取默认的音频前端配置结构然后根据需要调整参数我们启用了来打开唤醒词检测而将置为因为这两者不能同时为通话模式用于双工通话情景不在本项目范围指定要加载的唤醒词模型的名字例如这里假设我们有名为的模型实际上需要先把模型文件烧录进或设为单通道检测如果有双麦克风可以用相应的双通道模式以提升远场性能使用初始化语音识别句柄然后调用加载唤醒词模型如果返回则表示模型加载成功可以开始检测通过注册一个回调函数当在音频流中检测到目标关键词时这个回调就会被调用在回调函数中我们可以进行接下来的处理例如开始录音等需要注意提前将所需的唤醒词模型文件添加到工程中通常提供了一些预训练模型可以在菜单配置中选中如乐鑫等如果要自定义唤醒词则需要使用乐鑫提供的工具训练模型然后集成处理语音输入并上传至大模型当唤醒词被检测到时应该切换到对用户语音指令的录制和传输流程典型做法是在回调中通知主程序开始录音可以创建一个音频采集任务持续从麦克风读取音频数据直到检测到一段静音表示用户说话结束或达到最大录音时长然后通过网络将音频发送出去音频采集提供驱动来读取麦克风数据麦克风模块通常以固定采样率输出比如位音频我们可以设置每次读取一定帧数的数据到内存缓冲区为了简单我们假设每次读取大小的数据块并将其暂存如果需要判断何时用户说话结束可以实现一个简单的静音检测连续几百毫秒检测音量如果音量低于阈值则认为用户讲话结束数据上传这里提供两种策略流式上传推荐边录音边通过网络发送数据段利用前文建立的连接将每个缓冲区的数据通过发给服务器这样服务器可同步识别不需等全部录完这种方法实现对话响应更快后端上传简单先本地录完整句话存成或格式然后通过一次请求将音频文件发送给服务器等待服务器返回结果在初期调试时此方法更直观但交互上会有一点延迟我们以流式方式为例展示录音与发送的伪代码假设已经建立好连接句柄为每次读取字节个采样唤醒词检测到开始录音可选暂停以节省连续静音块计数阈值连续循环读取麦克风数据阻塞读取一块音频数据未触发录音就丢弃数据将读取的数据通过发出简单静音检测如果本次数据全是低幅值接近静默如果连续多帧静默认为讲话结束发送特殊标志表示音频结束重新启用唤醒监听录音结束等待回复上述代码中会一直运行平时标志为时读入的数据直接丢弃或可缓冲覆盖当唤醒发生时回调将置为于是任务开始真正处理音频数据通过从采集字节音频每采集到一块就用发送二进制数据帧给服务器这里假定已在别处初始化了客户端并连接到服务器地址例如服务器端口的客户端是线程安全的可直接从任务中调用发送函数是用户定义的函数用于检查缓冲中是否绝大部分样本都接近零可设定一个幅值阈值如果连续检测到若干帧静音我们就认为用户停止了讲话这时通过发送一条特殊的文本帧通知服务器音频流结束然后把置回表示本轮录音完成还调用恢复唤醒词检测让设备准备接受下一次唤醒注意上述实现相对简单实际应用中可能需要更健壮的算法来准确判断讲话结束另外为了防止用户长时间讲话导致数据过多可以设置最大录制时长到点后强制结束本示例省略了错误处理和资源管理例如在结束录音后可能需要关闭或重置缓冲等与云端模型的交互并返回文本当将语音数据发送到服务器后接下来就轮到服务器端进行处理把音频转成文本交给大模型生成回复再将回复发送回来因此需要能接收服务器的响应数据在流式方案中服务器可能通过发回文本回复在简单方案中则是主动请求获取结果我们这里以双工通信为例说明的客户端支持接收服务器推送的消息可以注册回调或在循环中使用来获取数据在本例中我们假定服务器最终发送回来的内容是纯文本的对话回复或者为了简便也可以让服务器直接返回语音合成后的等但初期我们用文本即可收到文本后需要在本地加以处理如在串口打印或者显示在屏幕上或者通过播放出来以下是接收回复并处理的示例代码简单起见在主任务里轮询接收服务器消息以结尾形成字符串服务器确认收到音频的应答可忽略或用于统计云端回复将回复显示到屏幕伪函数可选调用本地播放语音此处省略这个循环会一直等待的消息阻塞等待服务器发送的数据收到后我们检查内容如果是预定义的控制消息例如这里假设服务器可能发表示收到结束标志那么不做处理否则将其作为正常回复文本处理通过串口打印出回复并调用一个假定的函数在上显示该文字实际实现中您需要用相应的屏幕驱动将文字绘制出来如使用驱动或库如果您希望机器人语音回答可以在上集成一个简单的本地框架本身带有简易的中文语音合成功能或让服务器直接返回合成后的语音例如文件或音频流初始阶段为了专注核心我们先不处理至此端的主要代码逻辑已经完整等待唤醒录音上传接收回复输出结果循环等待下一次唤醒接下来我们看看云端服务器该如何部署大模型来配合工作云端部署云端或本地服务器在整个系统中承担了重型计算的任务包括语音识别和对话生成根据硬件条件和需求您可以选择自建服务器或使用云服务本节将介绍如何连接大语言模型以及如何搭建服务器端程序来实现智能对话连接大语言模型等大语言模型的选择取决于您的资源对于中文对话比较好的开源选择有阿里巴巴的通义千问系列和衍生的模型如果有足够算力您可以在服务器上直接运行开源模型实例例如使用加载基于模型然后在本地执行推理伪代码如下假设已经得到用户输入文本上述代码会生成作为回复但需要注意这对模型至少需要十几显存或使用耗时较长因此如果硬件有限不妨考虑调用在线服务另一种便利的方法是使用模型提供方的云例如阿里云的通义千问提供了可以直接通过请求获得回复无需本地运行模型您只需在阿里云申请然后按照文档构造请求通常是一个包含会话历史的以下是使用的伪代码你的通义利用在线大模型服务的优势是省去了部署模型的麻烦而且一般响应速度快效果好不过要考虑到接口的使用费用或调用频率限制无论采用哪种方式获取对话回复都应该注意实现上下文管理即让模型记住之前的对话历史从而实现连贯的多轮对话这可以通过每次调用时在中附带前文对话或使用模型的对话模式接口来实现在通义这样的模型中一般支持多轮对话只需将历史问答拼接即可或在参数中传递等调用语音识别在让大模型理解用户意图之前我们需要将音频转成文字这里我们使用之前准备好的模型服务假设您已在服务器上运行了的例如本地服务端点为发送的音频通过或转发给该服务进行识别如果采用我们上节的方案服务器可以在收到的音频帧后将其拼接或直接送入语音识别引擎进行流式识别阿里的支持长语音转写和多语言可以逐步输出转写结果简化流程如下服务器收到音频数据帧缓存至音频缓冲区如果检测到结束标志则将缓冲区音频送入引擎获取到完整的转写文本调用大模型生成通过将发回在实现中可将步骤集成在服务器的一个事件循环或多线程处理里您也可以选择不等音频结束就边识别边生成但那会复杂许多需要分段多段上下文管理这里不深入服务器端搭建服务您可以用任意擅长的语言编写服务器例如用的库搭建服务收到二进制音频后调用接口处理这需要加载模型和大模型可能耗时建议在服务器启动时就加载好模型到内存避免每次请求重复初始化以下是服务器伪代码框架假设封装好的识别类假设封装的大模型调用加载识别模型初始化大模型客户端已连接累积音频数据收到音频结束语音转文本识别结果调用大模型获取回复发送回复给清空缓冲准备下一次对话处理其他控制消息例如心跳确认这个简化的服务器逻辑中我们使用来持续监听来自某个客户端的消息如果收到的是二进制数据则累加到缓冲如果收到文本则表示一段语音结束遂调用将整个音频转为文字然后把文字传给大模型接口获得回复最后通过将回复发回客户端然后清空缓冲等待下一轮交流这里还示范了收发之类的控制信息的处理实际应用中应考虑异常处理如网络中断识别超时等情况通过上述服务器的配合我们的语音机器人基本功能就完成了当你对着麦克风说小智小智假定这是唤醒词检测到后开始录音并把你的话通过网络发送出去服务器将你的语音识别为文字再由大模型生成回答好的我在呢示例服务器将回答发送回接收到后在屏幕上显示出来并通过扬声器播报出来整个过程接近实时并且可以多次轮询实现连续对话优化与扩展在基本功能实现后我们可以对小智机器人进行多方面的优化和扩展以提升体验和性能提升本地计算能力虽然性能有限但我们可以通过一些技巧优化运行效率例如使用缓存机制针对用户经常询问的问题可以在端缓存上一次的回答若短时间内再次询问相同问题可以直接回复缓存结果而不必每次都请求云端从而降低延迟和流量另外尽量利用好的硬件加速功能如采用定点运算或使用库优化音频处理对于云端的大模型可以考虑模型蒸馏或量化来加快推理速度例如将原本大的模型压缩为更小的参数这也是提供蒸馏模型的思路量化后的模型如在甚至上的推理速度会有明显提升使对话响应更快同时可在服务器端对相似的问答进行缓存减少重复计算增强离线功能目前我们的机器人主要依赖云端但是我们可以赋予它一定的脱机能力首先上的命令词识别模块可以识别一些常用指令词离线运行我们可以预先定义一组本地指令例如播放音乐停止音量大一点等并训练相应模型烧录进这使得即使断网机器人也能执行简单指令控制此外可以加入简单的本地问答库或规则例如对于固定的问题天气时间在存储预设答案这样在无网络时也能回答部分问题更高级的可以在上运行一个超小型的语言模型例如基于或等用于应对非常简短的对话不过由于设备限制这类模型智能性有限主要作为备份在应用中可以设置策略优先调用云端若不可用则退而求其次使用本地能力应答显示屏交互扩展为了让小智更生动我们可以充分利用显示屏来丰富人机界面例如在屏幕上显示对话文字的同时可以加入表情或头像来指示机器人状态听的时候显示耳朵图标思考时显示加载中动画说话时显示嘴巴或表情变化等如果使用的是彩色屏幕可以绘制一个卡通头像小智在不同状态下的表情睁眼闭眼说话变化从而使机器人更具亲和力技术实现上可以预先加载几张位图或者使用简单的绘图指令组合出表情在中可以结合图形库实现精美的界面包括文本图像和动画效果触摸屏设备还可以扩展触控功能例如加一个对话历史查看或功能菜单除了屏幕您还可以增添指示灯比如显示不同颜色代表正在录音或思考或者蜂鸣器音效提示用户进行交互提示语音合成输出虽然本教程侧重文字输出但让机器人开口说话无疑会提供更直观的互动在上实现文本转语音有几种方案可以利用自带的简易模块生成中文语音或者占用稍多资源集成一个轻量级的引擎如科大讯飞离线不过对和要求较高再或者走云端由服务器把回复文本经过合成后以音频文件发送给播放最后一种方式对压力最小只需接收和播放音频即可在具体实现时可以在服务器端调用诸如阿里云易音识别微软等云服务将回答文本转为语音然后通过获取文件使用集成的音频解码器播放若追求本地纯离线也可考虑安装一个小型解码库将服务器传来的数据用解码输出至扬声器有足够能力播放中等码率的语音合成的声音可以自定义让小智有独特的音色其他扩展创意小智机器人可以结合更多传感器和功能模块实现丰富的玩法例如加入摄像头模块支持连接摄像头配合云端的视觉识别实现看图对话或人脸识别后的个性化对话或者集成舵机作为头部让机器人朝向发声方向转动添加触摸传感器或按钮让用户可以用触摸来激活对话等此外如果追求更强的本地能力可以关注乐鑫新推出的等更高性能芯片或者结合加速器来运行部分模型对于软件层面也可以将当前方案与其他开源框架集成例如接入平台实现家居语音控制或使用框架设计机器人的对话流程和工具调用能力让小智不仅能聊天还能帮忙查询资料控制设备通过以上优化小智机器人将变得更加实用和智能在联网时它是一个功能全面的语音助手能聊天查信息控制家电离线时它仍具备基本的指令识别和交流能力不仅如此借助的开源生态您可以不断为小智添加新功能在实践过程中请充分利用社区资源参考官方示例查看类似项目源码这将有助于您更深入地理解实现细节并排除开发中的困难结语恭喜您完成这个从无到有的项目通过本教程我们学习了上语音唤醒的原理搭建了语音对话硬件平台编写了嵌入式代码将语音与云端连接并了解了如何部署强大的大模型服务来实现智能对答对于初学者来说这是迈向物联网世界的重要一步当然受限于时间和篇幅教程中的很多模块都是简化的但希望这份详细指南为您理清了思路在实际开发中您可能会遇到各种挑战比如噪声环境下识别率网络延迟导致的响应速度不同模块兼容性等不要气馁多查阅资料多尝试调优借助开源社区的力量您的小智一定可以变得越来越聪明期待您为它赋予更多有趣的技能祝您玩得开心在创作的道路上不断进步参考文献开源语音识别框架模块组成及功能嵌入式设备语音唤醒和识别原理指令和优势技术架构唤醒词模型工作机制实时语音助手项目音频流传输架构本地语音助手实现讨论建立及音频传输流程语音硬件建议优选数字麦克风避免模拟麦克风噪声博客语音唤醒教程上唤醒词和命令词识别案例阿里达摩院开源项目多语言语音识别模型简介及能力项目说明开源大型语言模型性能及开放版本开源项目通义千问使用示例',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-05-12 20:04:01',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/img/up.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">关注我</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/tenxiaodao/tenxiaodao.github.io" title="Github"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/up.jpg" alt="Github"/><span class="back-menu-item-text">Github</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1803174585" title="Bilibili"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/up.jpg" alt="Bilibili"/><span class="back-menu-item-text">Bilibili</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">网盘</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://pan.quark.cn/s/c98d1ceee692" title="软件/工具"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="软件/工具"/><span class="back-menu-item-text">软件/工具</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">首页</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=13738866688&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/img/wx.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src="/img/wx.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="/null"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size: 1.05rem;">AI<sup>1</sup></a><a href="/tags/ARP/" style="font-size: 1.05rem;">ARP<sup>1</sup></a><a href="/tags/CasaOS/" style="font-size: 1.05rem;">CasaOS<sup>1</sup></a><a href="/tags/Docker/" style="font-size: 1.05rem;">Docker<sup>1</sup></a><a href="/tags/ESP32/" style="font-size: 1.05rem;">ESP32<sup>1</sup></a><a href="/tags/GitHub-Pages/" style="font-size: 1.05rem;">GitHub Pages<sup>1</sup></a><a href="/tags/Hexo/" style="font-size: 1.05rem;">Hexo<sup>6</sup></a><a href="/tags/KVM/" style="font-size: 1.05rem;">KVM<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>2</sup></a><a href="/tags/Markdown/" style="font-size: 1.05rem;">Markdown<sup>2</sup></a><a href="/tags/NAS/" style="font-size: 1.05rem;">NAS<sup>1</sup></a><a href="/tags/Node-js/" style="font-size: 1.05rem;">Node.js<sup>1</sup></a><a href="/tags/Python/" style="font-size: 1.05rem;">Python<sup>3</sup></a><a href="/tags/Scrapy/" style="font-size: 1.05rem;">Scrapy<sup>2</sup></a><a href="/tags/TCP/" style="font-size: 1.05rem;">TCP<sup>1</sup></a><a href="/tags/UDP/" style="font-size: 1.05rem;">UDP<sup>1</sup></a><a href="/tags/Ubuntu/" style="font-size: 1.05rem;">Ubuntu<sup>1</sup></a><a href="/tags/WSL2/" style="font-size: 1.05rem;">WSL2<sup>1</sup></a><a href="/tags/Windows/" style="font-size: 1.05rem;">Windows<sup>2</sup></a><a href="/tags/macOS/" style="font-size: 1.05rem;">macOS<sup>1</sup></a><a href="/tags/office/" style="font-size: 1.05rem;">office<sup>1</sup></a><a href="/tags/windows%E9%95%9C%E5%83%8F/" style="font-size: 1.05rem;">windows镜像<sup>1</sup></a><a href="/tags/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" style="font-size: 1.05rem;">个人博客<sup>1</sup></a><a href="/tags/%E4%B8%BB%E9%A2%98%E9%85%8D%E7%BD%AE/" style="font-size: 1.05rem;">主题配置<sup>1</sup></a><a href="/tags/%E4%BA%A4%E6%8D%A2%E6%9C%BA/" style="font-size: 1.05rem;">交换机<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">前端开发<sup>2</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD/" style="font-size: 1.05rem;">前端性能<sup>1</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2%E4%BC%98%E5%8C%96/" style="font-size: 1.05rem;">博客优化<sup>1</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" style="font-size: 1.05rem;">博客搭建<sup>4</sup></a><a href="/tags/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/" style="font-size: 1.05rem;">压力测试<sup>1</sup></a><a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 1.05rem;">爬虫<sup>2</sup></a><a href="/tags/%E7%8E%A9%E5%AE%A2%E4%BA%91/" style="font-size: 1.05rem;">玩客云<sup>1</sup></a><a href="/tags/%E7%AB%AF%E5%8F%A3%E8%81%9A%E5%90%88/" style="font-size: 1.05rem;">端口聚合<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%AB%99%E6%90%AD%E5%BB%BA/" style="font-size: 1.05rem;">网站搭建<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96/" style="font-size: 1.05rem;">网络优化<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" style="font-size: 1.05rem;">网络协议<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">网络安全<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E6%8A%80%E6%9C%AF/" style="font-size: 1.05rem;">网络技术<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/" style="font-size: 1.05rem;">网络配置<sup>1</sup></a><a href="/tags/%E8%AF%AD%E9%9F%B3%E5%8A%A9%E6%89%8B/" style="font-size: 1.05rem;">语音助手<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/01/"><span class="card-archive-list-date">一月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%94%9F%E6%B4%BB%E6%97%A5%E5%B8%B8/" itemprop="url">生活日常</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/AI/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>AI</span></a><a class="article-meta__tags" href="/tags/ESP32/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>ESP32</span></a><a class="article-meta__tags" href="/tags/%E8%AF%AD%E9%9F%B3%E5%8A%A9%E6%89%8B/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>语音助手</span></a></span></div></div><h1 class="post-title" itemprop="name headline">DIY电子女友小智</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-04-12T15:53:33.000Z" title="发表于 2025-04-12 23:53:33">2025-04-12</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-05-12T12:04:01.291Z" title="更新于 2025-05-12 20:04:01">2025-05-12</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为大同"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>大同</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2025/04/12/25-4-12ai%E5%B0%8F%E6%99%BA/#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://bu.dusays.com/2025/04/13/67fa94a426f38.png"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2025/04/12/25-4-12ai%E5%B0%8F%E6%99%BA/"><header><a class="post-meta-categories" href="/categories/%E7%94%9F%E6%B4%BB%E6%97%A5%E5%B8%B8/" itemprop="url">生活日常</a><a href="/tags/AI/" tabindex="-1" itemprop="url">AI</a><a href="/tags/ESP32/" tabindex="-1" itemprop="url">ESP32</a><a href="/tags/%E8%AF%AD%E9%9F%B3%E5%8A%A9%E6%89%8B/" tabindex="-1" itemprop="url">语音助手</a><h1 id="CrawlerTitle" itemprop="name headline">DIY电子女友小智</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">周言志</span><time itemprop="dateCreated datePublished" datetime="2025-04-12T15:53:33.000Z" title="发表于 2025-04-12 23:53:33">2025-04-12</time><time itemprop="dateCreated datePublished" datetime="2025-05-12T12:04:01.291Z" title="更新于 2025-05-12 20:04:01">2025-05-12</time></header><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>此博客为一篇针对初学者的详细教程，涵盖小智 AI 机器人的原理、硬件准备、软件环境搭建、代码实现、云端部署以及优化扩展。文章结合了现有的网络资源，取长补短，确保内容易于理解和操作。</p>
<h2 id="教程目标"><a href="#教程目标" class="headerlink" title="教程目标"></a>教程目标</h2><p>本教程将指导初学者使用 ESP32 微控制器开发一个简单的语音对话机器人“小智”。我们将介绍所需的基础原理、硬件准备、软件环境搭建，以及如何编写代码实现语音唤醒和与云端大模型的对接。</p>
<p>通过本教程，即使没有深厚的 AI 或嵌入式经验，也可以一步步制作出一个能听懂唤醒词并与人对话的简易 AI 机器人。本教程提供详细的操作步骤、代码示例和图示，帮助您轻松上手。</p>
<hr>
<h2 id="1-基础原理"><a href="#1-基础原理" class="headerlink" title="1. 基础原理"></a>1. 基础原理</h2><h3 id="ESP32-架构及其在-AI-领域的应用"><a href="#ESP32-架构及其在-AI-领域的应用" class="headerlink" title="ESP32 架构及其在 AI 领域的应用"></a>ESP32 架构及其在 AI 领域的应用</h3><p>ESP32 是一款集成 Wi-Fi 和蓝牙的双核微控制器，具有较高的主频和丰富的外设接口，适合物联网和嵌入式 AI 应用。特别是新版的 ESP32-S3 芯片，不仅运行频率高达 240MHz，还内置了向量加速指令（有时称为“AI 指令”）并支持高速 PSRAM，从而可以在一定程度上加速神经网络推理 (以乐鑫语音开发框架为例，系统了解嵌入式设备的语音唤醒和语音识别-RoboticsCV)。在 AI 领域，ESP32 常用于边缘设备，执行一些轻量级的本地 AI 任务（如语音关键词检测、简单的图像识别等），或充当连接云端 AI 服务的桥梁。由于资源有限，ESP32 无法独立运行大型深度学习模型，但它可以负责前端的数据采集和初步处理（如音频处理），然后将数据传输给云端或本地服务器上的强大 AI 模型进行复杂计算，再将结果返回设备。这样的架构充分利用了 ESP32 的实时控制能力和云端大模型的强大推理能力。</p>
<h3 id="语音唤醒模块（ESP-SR）的工作原理"><a href="#语音唤醒模块（ESP-SR）的工作原理" class="headerlink" title="语音唤醒模块（ESP-SR）的工作原理"></a>语音唤醒模块（ESP-SR）的工作原理</h3><p>乐鑫官方提供了 ESP-SR (Speech Recognition)语音识别框架，包含唤醒词引擎（WakeNet）、命令词识别（MultiNet）等组件 (以乐鑫语音开发框架为例，系统了解嵌入式设备的语音唤醒和语音识别-RoboticsCV)。其中唤醒词功能用于在设备待机时持续监听音频流，当检测到特定的唤醒词时触发设备进入对话&#x2F;识别状态。例如，我们可以将“小智小智”设定为唤醒词。当 ESP32 运行 WakeNet 模型时，它会不断从麦克风录制音频并计算梅尔频谱倒谱系数（MFCC）等特征，然后通过一个针对 ESP32-S3 优化的神经网络算法对特征进行分类 (esp-box&#x2F;docs&#x2F;technical_architecture_cn.md at master · espressif&#x2F;esp-box · GitHub)。一旦检测到训练好的关键词序列，WakeNet 就输出唤醒信号，唤醒设备进入语音交互状态 (esp-box&#x2F;docs&#x2F;technical_architecture_cn.md at master · espressif&#x2F;esp-box · GitHub)。这种本地唤醒机制即使在有环境噪声的情况下也能保持较高的准确率（官方数据显示在噪声环境下识别率不低于 80% (esp-box&#x2F;docs&#x2F;technical_architecture_cn.md at master · espressif&#x2F;esp-box · GitHub)）。ESP-SR 默认提供了一些开箱即用的唤醒词模型（如 “Hi, ESP” 或 “Hi, 乐鑫”)，开发者也可以定制自己的唤醒词模型 (esp-box&#x2F;docs&#x2F;technical_architecture_cn.md at master · espressif&#x2F;esp-box · GitHub)。工作流程是：麦克风采集到的模拟音频经前端处理（降噪、增益等），送入 WakeNet 模型进行关键词检测。如果未检测到唤醒词，设备保持低功耗待机；一旦检测到唤醒词，设备即进入后续的语音识别或对话流程。同时，为了节省运算资源，ESP32 在唤醒后通常会暂停 WakeNet，以便释放 CPU 处理后续音频；待对话完成后再重新启用 WakeNet 监听下一个唤醒词 (以乐鑫语音开发框架为例，系统了解嵌入式设备的语音唤醒和语音识别-RoboticsCV)。</p>
<h3 id="流式对话的概念及-WebSocket-UDP-传输机制"><a href="#流式对话的概念及-WebSocket-UDP-传输机制" class="headerlink" title="流式对话的概念及 WebSocket&#x2F;UDP 传输机制"></a>流式对话的概念及 WebSocket&#x2F;UDP 传输机制</h3><p>所谓流式对话，是指机器人在唤醒后能够实时地接收和发送数据，与用户进行连续的对话交流，而非一次性等待用户说完整句子再回复。要实现流式对话，ESP32 需要将用户的语音数据边录制边发送到云端的语音识别&#x2F;大模型服务，并且及时接收对方返回的回复数据。这通常涉及到稳定高效的网络传输机制。常用的方式有两种：</p>
<h4 id="WebSocket-通信"><a href="#WebSocket-通信" class="headerlink" title="WebSocket 通信"></a>WebSocket 通信</h4><p>WebSocket 是基于 TCP 的全双工长连接协议，非常适合实时数据交换。一旦建立连接，服务器和客户端（ESP32）都可以随时发送数据而不需要重复握手。在本项目中，可在 ESP32 启动时就建立一个通向服务器的 WebSocket长连接 (Building a fully local LLM voice assistant to control my smart home | Hacker News)。ESP32 检测到唤醒词后，立即通过该 WebSocket 流式发送音频数据到服务器 (Building a fully local LLM voice assistant to control my smart home | Hacker News)。服务器一边接收音频流一边进行语音识别，并将部分结果或最终结果通过同一连接发回给 ESP32。得益于 WebSocket 保持的长连接，数据可以持续、快速地往返，实现即时的对话体验。例如，有开发者采用 ESP32 + Node.js 服务器架构，通过 WebSocket传输音频，实现实时的语音助手 (I created a Realtime Voice Assistant for my ESP-32, here is my journey - Part 2 : Node, OpenAI, Langchain - DEV Community)。</p>
<h4 id="UDP-传输"><a href="#UDP-传输" class="headerlink" title="UDP 传输"></a>UDP 传输</h4><p>UDP 是基于数据报的传输协议，开销小、延迟低，但不保证可靠送达。在一些对实时性要求极高且可以容忍少量数据丢失的场景，可以考虑使用 UDP 将音频帧连续地发送到服务器。不过 UDP 没有内建重发、排序机制，需要应用层自行处理丢包重传或顺序问题。因此，对于初学者项目来说，UDP 方案实现难度略高，而且在局域网环境下 WebSocket 已经可以提供足够低的延迟和可靠性。所以通常推荐使用 WebSocket 实现流式语音对话，在开发和调试阶段简便可靠 (PipeCat - 打造实时语音 AI 应用的开源架构方案 - 53AI-AI生产力的卓越领导者（大模型知识库|大模型训练|智能体开发）)。待项目成熟后，再根据需要考虑是否切换更底层的传输方案（如 WebRTC 等高级方案 (PipeCat - 打造实时语音 AI 应用的开源架构方案 - 53AI-AI生产力的卓越领导者（大模型知识库|大模型训练|智能体开发）)）。</p>
<p>总结来说，本项目将利用 ESP32-S3 的本地语音唤醒能力，让设备在检测到“小智”唤醒词后，开始录音并流式发送音频到云端，通过 WebSocket 与服务器上的大语言模型保持对话数据的实时交互。当云端返回文本应答后，ESP32 可将其显示在屏幕上（或语音播报），从而完成一次人机对话循环。</p>
<hr>
<h2 id="2-硬件准备"><a href="#2-硬件准备" class="headerlink" title="2. 硬件准备"></a>2. 硬件准备</h2><p>要制作一个语音对话机器人，我们需要准备以下硬件组件，并确保它们兼容且正确连接：</p>
<h3 id="ESP32-S3-开发板（带有-PSRAM）"><a href="#ESP32-S3-开发板（带有-PSRAM）" class="headerlink" title="ESP32-S3 开发板（带有 PSRAM）"></a>ESP32-S3 开发板（带有 PSRAM）</h3><p>核心控制器，大脑所在。建议选择 ESP32-S3 系列开发板，因其具备AI加速指令集和高速PSRAM，可支持语音唤醒等 AI 功能 (以乐鑫语音开发框架为例，系统了解嵌入式设备的语音唤醒和语音识别-RoboticsCV)。常见选项包括官方的 ESP32-S3-DevKitC-1（WROVER模块带8MB PSRAM）、或多合一的语音开发板如 ESP32-S3-Korvo 系列和 ESP32-S3-BOX 等 (以乐鑫语音开发框架为例，系统了解嵌入式设备的语音唤醒和语音识别-RoboticsCV)。这些板子自带麦克风阵列、音频编解码等硬件，方便语音应用开发。</p>
<h3 id="麦克风"><a href="#麦克风" class="headerlink" title="麦克风"></a>麦克风</h3><p>用于采集用户语音。强烈推荐使用 I2S 接口的数字麦克风（MEMS麦克风），例如 INMP441 模块。数字麦克风可以直接将音频数据以数字信号传给 ESP32，抗干扰能力强，音质更好 (Building a fully local LLM voice assistant to control my smart home | Hacker News)。避免使用模拟麦克风加ADC的方法，因为ESP32自带的ADC精度有限且噪声较大，模拟方案音质往往不佳 (Building a fully local LLM voice assistant to control my smart home | Hacker News)。常用的 I2S 麦克风模块有 INMP441、ICS-43434 等，它们需要连接 ESP32 的 I2S接口引脚（WS, SCK, SD 等）以及电源。</p>
<h3 id="扬声器和音频放大器（可选）"><a href="#扬声器和音频放大器（可选）" class="headerlink" title="扬声器和音频放大器（可选）"></a>扬声器和音频放大器（可选）</h3><p>用于语音播报机器人回复。如果希望机器人能“说话”，需要一个小型扬声器（如 4Ω 3W）的输出方案。ESP32 可以通过内置 DAC 输出模拟音频，但驱动扬声器需要功率放大器。常用方案是使用 I2S 数字功放模块（如 MAX98357A）将 ESP32 的I2S音频输出转换为扬声器驱动信号。该模块接收ESP32的I2S数据和时钟，输出功率音频信号，直接驱动小喇叭。如果暂时不需要语音输出，也可以先不接扬声器，后续通过串口日志或屏幕查看机器人回复的文本。</p>
<h3 id="显示屏（OLED-LCD，可选）"><a href="#显示屏（OLED-LCD，可选）" class="headerlink" title="显示屏（OLED&#x2F;LCD，可选）"></a>显示屏（OLED&#x2F;LCD，可选）</h3><p>用于显示对话内容或机器人表情。一个小型显示屏可以显著增强人机交互体验。初学者可以选用I2C接口的单色 OLED（如0.96寸 128×64 OLED）或 SPI 接口的彩色 LCD（如1.3寸 240×240 TFT）。这些屏幕可以用来显示用户说的内容和机器人生成的回复文字，或显示一些图标、头像来提示当前状态（正在听&#x2F;在想&#x2F;在说等）。显示屏通过 I2C 或 SPI 接口连接到 ESP32 的对应引脚，并需要供电。后续可以使用图形库（如 LVGL）或驱动库来控制显示内容。</p>
<h3 id="其他配件"><a href="#其他配件" class="headerlink" title="其他配件"></a>其他配件</h3><p>若使用独立的开发板和模块，还需要若干 面包板和连接线 方便搭建原型、电源线和 USB 数据线等。如果选用的是类似 ESP32-S3-BOX 这类集成度高的设备，许多组件（屏幕、麦克风、扬声器）已经内置，无需额外连接。 (以乐鑫语音开发框架为例，系统了解嵌入式设备的语音唤醒和语音识别-RoboticsCV)</p>
<p>图：ESP32-S3-Korvo-2 音频开发板（乐鑫官方语音开发套件）示例，板载双麦克风、音频编解码芯片、扬声器接口和LCD接口等，方便构建语音交互设备 (以乐鑫语音开发框架为例，系统了解嵌入式设备的语音唤醒和语音识别-RoboticsCV)。</p>
<p>(image)</p>
<p>图：使用 ESP32 开发板+麦克风+扬声器搭建语音助手原型的实际连接示例。ESP32 开发板（右下）通过面包板连接麦克风（中间小圆件）和扬声器（左上黑色喇叭），用于采集和播放语音。</p>
<h3 id="选购建议"><a href="#选购建议" class="headerlink" title="选购建议"></a>选购建议</h3><p>如果希望尽量减少硬件连接的麻烦，可以选择类似 ESP32-S3-BOX 或 ESP32-S3-Korvo 这样的开发套件，它们集成了语音所需的大部分硬件，开箱即可使用唤醒词和语音功能 (esp-box&#x2F;docs&#x2F;technical_architecture_cn.md at master · espressif&#x2F;esp-box · GitHub)。例如，ESP32-S3-BOX 自带触摸屏、双麦克风和扬声器，只需刷入程序即可成为一个简单语音助手。不过这类套件价格相对较高。对于学习和制作原型来说，使用普通的 ESP32-S3 开发板加上外接麦克风和屏幕也是常用方案，性价比更高。在购买麦克风模块时，要确认其引脚定义与ESP32兼容（一般接 3.3V、GND、WS、SCK、SD），并注意麦克风的指向性、灵敏度等参数，以满足您的应用（如近场对话一般使用全指向麦克风，远场则考虑阵列降噪技术）。扬声器方面，小功率扬声器即可满足语音提示功能；若追求更大音量，可考虑使用有源音箱或更高功率的放大器，但要注意供电能力。显示屏选型取决于需求和预算，初期可以使用廉价的0.96寸OLED显示文字，后期可升级为彩屏显示头像或图形界面。</p>
<p>总之，在硬件搭建阶段，请按照各模块的规格说明正确连接电路，并确保供电稳定（ESP32 开发板通常通过 USB 供电，确保电脑USB口或电源适配器有足够的电流供应）。完成硬件连接后，我们就可以着手软件环境的搭建与代码编写了。</p>
<hr>
<h2 id="3-软件环境搭建"><a href="#3-软件环境搭建" class="headerlink" title="3. 软件环境搭建"></a>3. 软件环境搭建</h2><p>在开始编程之前，需要搭建好 ESP32 的开发环境，以及准备云端大模型所需的工具库。</p>
<h3 id="安装-ESP-IDF-开发框架"><a href="#安装-ESP-IDF-开发框架" class="headerlink" title="安装 ESP-IDF 开发框架"></a>安装 ESP-IDF 开发框架</h3><p>ESP-IDF（Espressif IoT Development Framework）是乐鑫官方的底层开发框架。我们将使用 ESP-IDF 来编写 C&#x2F;C++ 代码控制 ESP32。请根据您的操作系统安装相应版本的 ESP-IDF。建议使用最新版（如 v5.x），以便支持 ESP32-S3 和 ESP-SR 库。安装方法如下：</p>
<ul>
<li>Windows 用户： 可以使用乐鑫提供的安装包，其中集成了 IDF、编译工具链和 Python 环境等。一键安装后，运行 ESP-IDF 提供的命令行快捷方式进入开发环境。</li>
<li>Linux&#x2F;Mac 用户： 可通过 git 克隆 ESP-IDF 仓库，然后运行 install.sh 脚本安装所需工具链和Python包。安装完成后，运行 export.sh 脚本配置环境变量。</li>
</ul>
<p>详细步骤可参考乐鑫官方文档，但总的来说，安装完成后在命令行执行 idf.py –version 能看到版本信息即表示环境就绪。接下来创建一个 ESP-IDF 项目或者使用官方示例作为起点。</p>
<h3 id="配置-VSCode-Cursor-开发环境"><a href="#配置-VSCode-Cursor-开发环境" class="headerlink" title="配置 VSCode&#x2F;Cursor 开发环境"></a>配置 VSCode&#x2F;Cursor 开发环境</h3><p>为了提高开发效率，我们推荐使用 VSCode 作为主要的代码编辑器，并安装乐鑫官方的 ESP-IDF VSCode 插件。该插件可以方便地菜单配置项目信息、一键编译烧录、监视串口输出等。您可以在 VSCode 的扩展商店搜索“Espressif IDF”并安装，然后按照插件指引配置 ESP-IDF 安装路径和 Python 环境。</p>
<p>除此之外，您也可以尝试使用最近流行的 Cursor 代码编辑器。Cursor 本质上是 VSCode 的一个改进版本，内置了 GPT-4、Claude 2 等大型语言模型作为编程助手 (用Cursor 写出第一个程序- 架构师汤师爷 - 博客园)。使用 Cursor，您可以在编写代码时得到 AI 对代码的提示、自动补全和错误检查等智能帮助 (用Cursor 写出第一个程序- 架构师汤师爷 - 博客园)。这对初学者调试语音项目这样的复杂工程非常有益。例如，当您不知道某个 ESP-IDF 函数如何使用时，可以直接在 Cursor 中询问 AI 获取帮助。当然，使用 Cursor 并非必需，如果您习惯纯 VSCode 或其他编辑器也完全可以。</p>
<h3 id="安装所需库和工具"><a href="#安装所需库和工具" class="headerlink" title="安装所需库和工具"></a>安装所需库和工具</h3><p>本项目除了 ESP-IDF 自带的组件外，还可能需要用到一些专门的软件库，特别是在云端服务器部分，以实现语音识别和大语言模型对话功能。在开发电脑或服务器上，建议准备好以下工具：</p>
<ul>
<li>SenseVoice 语音识别模型及 API： 这是阿里巴巴达摩院开源的一个多语言语音理解模型，支持语音转文本(ASR)、语言识别、情感识别等功能 (GitHub - HG-ha&#x2F;SenseVoice-Api: 阿里SenseVoice的fastpi封装，采用onnx发布，体积更小，附带量化模型，支持GPU。支持从URL文件进行语音识别。)。相较于其他开源方案，SenseVoice 在中文等多语言识别上精度很高，据称训练了超40万小时语音数据，效果优于 OpenAI 的 Whisper 模型 (GitHub - HG-ha&#x2F;SenseVoice-Api: 阿里SenseVoice的fastpi封装，采用onnx发布，体积更小，附带量化模型，支持GPU。支持从URL文件进行语音识别。)。我们可以使用开源社区提供的 SenseVoice 推理代码或封装好的 API 服务。例如，GitHub 上的项目 SenseVoice-API 提供了基于 ONNXRuntime 的轻量级封装和 FastAPI 接口，方便我们将 SenseVoice 部署成一个本地服务 (GitHub - HG-ha&#x2F;SenseVoice-Api: 阿里SenseVoice的fastpi封装，采用onnx发布，体积更小，附带量化模型，支持GPU。支持从URL文件进行语音识别。)。请按照该项目说明安装所需依赖（如 Python 及 onnxruntime）并下载模型文件，然后启动服务用于将音频流转成文本。</li>
<li>DeepSeek &#x2F; Qwen 大语言模型： 为了让机器人更智能地对答，我们需要接入一个强大的大语言模型(LLM)。DeepSeek 是国内开源的一个系列大模型，基于强化学习技术训练，性能媲美一些商业模型 (deepseek-ai&#x2F;DeepSeek-R1-Distill-Qwen-7B · Hugging Face)。他们提供了多种版本，包括体积较小的蒸馏模型（如基于 Qwen-7B 的 DeepSeek-R1 Distill）以及更大的 Qwen-32B&#x2F;72B 模型 (deepseek-ai&#x2F;DeepSeek-R1-Distill-Qwen-7B · Hugging Face)。其中 Qwen (通义千问) 是阿里巴巴开源的大模型系列，7B 和 14B 版本已开源，而 72B 参数的模型则在阿里云上提供服务。您可以根据自身算力选择使用哪种模型：如果本地有高性能GPU，可以尝试部署7B左右参数的模型运行；如果没有，则可以考虑通过在线API调用这些模型的推理服务。阿里云提供了 DashScope API 接口来调用通义千问模型，只需注册获取 API Key 即可使用 (GitHub - zengjunc&#x2F;VocaMirror: 语镜VocaMirror——基于sensevoice、cosyvoice和qwen模型实现与“自身声音”对话)。无论本地部署还是云端API，请先安装好相应的Python库：如 Hugging Face Transformers（用于加载DeepSeek&#x2F;Qwen模型）或者官方提供的 SDK（如 DashScope SDK）。</li>
<li>其他工具： 音频处理库（如 pyaudio 或 soundfile）可能用于服务器录音或读取文件；用于 WebSocket 通信的库（如 websockets for Python 或 Node.js 的 socket 库）如果您计划实现实时流式传输；以及 HTTP 客户端工具（如 requests）用于调用RESTful API 等。如果打算使用 Node.js 作为服务器，也需要准备好 Node.js 环境以及相关依赖（如用于 WebSocket 的ws库，用于调用AI服务的SDK等）。</li>
</ul>
<p>配置好以上软件环境后，整个开发流程将会是：使用 VSCode&#x2F;ESP-IDF 在本地编写并烧录 ESP32 端代码，同时使用 Python&#x2F;Node 等在电脑上编写服务器端代码并运行 AI 模型服务。接下来，我们就进入代码实现部分，看看如何让各部分协同工作。</p>
<hr>
<h2 id="4-代码实现"><a href="#4-代码实现" class="headerlink" title="4. 代码实现"></a>4. 代码实现</h2><p>在这一部分，我们将编写 ESP32 端的主要代码，实现以下功能：唤醒词检测、音频采集并上传、接收并处理云端返回的文本。代码将基于 ESP-IDF 编写，语言为 C&#x2F;C++。由于完整代码较长，这里拆分讲解关键步骤，并提供简化的代码示例。</p>
<h3 id="4-1-初始化语音唤醒功能"><a href="#4-1-初始化语音唤醒功能" class="headerlink" title="4.1 初始化语音唤醒功能"></a>4.1 初始化语音唤醒功能</h3><p>首先，我们需要初始化 ESP-SR 提供的唤醒词引擎，使能麦克风采集和关键词检测。假设我们使用 ESP32-S3 和官方 ESP-SR 库，初始化主要包括：配置 AFE（声学前端）参数、启用 WakeNet 模型、设置唤醒回调等。伪代码示例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_sr_iface.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;esp_sr_models.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 配置声学前端 (AFE) 参数</span></span><br><span class="line"><span class="type">afe_config_t</span> afe_config = AFE_CONFIG_DEFAULT(); <span class="comment">// 默认配置</span></span><br><span class="line">afe_config.wakenet_init = <span class="literal">true</span>; <span class="comment">// 启用唤醒词检测</span></span><br><span class="line">afe_config.voice_communication_init = <span class="literal">false</span>; <span class="comment">// 不启用通话模式，以免与唤醒冲突</span></span><br><span class="line">afe_config.wakenet_model_name = <span class="string">&quot;wn9_xiaozhi&quot;</span>; <span class="comment">// 指定唤醒词模型名称(假设我们有&quot;小智&quot;模型)</span></span><br><span class="line">afe_config.wakenet_mode = DET_MODE_1CH; <span class="comment">// 麦克风通道: 单通道模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 初始化AFE，并加载唤醒词模型</span></span><br><span class="line"><span class="type">sr_handle_t</span> sr_handle = sr_handle_init(&amp;afe_config);</span><br><span class="line"><span class="keyword">if</span> (!sr_handle) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ESP-SR 初始化失败\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">esp_err_t</span> ret = sr_wakenet_init(sr_handle);</span><br><span class="line"><span class="keyword">if</span> (ret == ESP_OK) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;唤醒词引擎加载成功\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 注册唤醒回调，当检测到唤醒词时执行</span></span><br><span class="line">sr_set_wakenet_cb(sr_handle, on_wakeup_detected);</span><br></pre></td></tr></table></figure>

<p>上面代码说明：</p>
<ul>
<li>使用 AFE_CONFIG_DEFAULT() 宏获取默认的音频前端配置结构，然后根据需要调整参数。我们启用了 wakenet_init 来打开唤醒词检测，而将 voice_communication_init 置为 false，因为这两者不能同时为 true（通话模式用于双工通话情景，不在本项目范围）。wakenet_model_name 指定要加载的唤醒词模型的名字（例如这里假设我们有名为 “xiaozhi” 的模型，实际上需要先把模型文件烧录进 SPIFFS 或 Flash）。wakenet_mode 设为单通道检测，如果有双麦克风可以用相应的双通道模式以提升远场性能。</li>
<li>使用 sr_handle_init 初始化语音识别句柄，然后调用 sr_wakenet_init 加载唤醒词模型。如果返回 ESP_OK 则表示模型加载成功，可以开始检测。</li>
<li>通过 sr_set_wakenet_cb 注册一个回调函数 on_wakeup_detected，当 WakeNet 在音频流中检测到目标关键词时，这个回调就会被调用。在回调函数中我们可以进行接下来的处理（例如开始录音等）。</li>
</ul>
<p>需要注意提前将所需的唤醒词模型文件添加到工程中（通常 ESP-SR 提供了一些预训练模型，可以在菜单配置中选中，如 “Hi 乐鑫” 等；如果要自定义唤醒词，则需要使用乐鑫提供的工具训练模型，然后集成）。</p>
<h3 id="4-2-处理语音输入并上传至大模型"><a href="#4-2-处理语音输入并上传至大模型" class="headerlink" title="4.2 处理语音输入并上传至大模型"></a>4.2 处理语音输入并上传至大模型</h3><p>当唤醒词被检测到时，ESP32 应该切换到对用户语音指令的录制和传输流程。典型做法是在回调中通知主程序开始录音。可以创建一个 音频采集任务，持续从 I2S 麦克风读取音频数据，直到检测到一段静音（表示用户说话结束）或达到最大录音时长，然后通过网络将音频发送出去。</p>
<h4 id="音频采集"><a href="#音频采集" class="headerlink" title="音频采集"></a>音频采集</h4><p>ESP32 IDF 提供 I2S 驱动来读取麦克风数据。麦克风模块通常以固定采样率输出，比如 16kHz 16位音频。我们可以设置 I2S DMA，每次读取一定帧数的数据到内存缓冲区。为了简单，我们假设每次读取 BUFFER_SIZE 大小的数据块，并将其暂存。如果需要判断何时用户说话结束，可以实现一个简单的静音检测（VAD）：连续几百毫秒检测音量，如果音量低于阈值则认为用户讲话结束。</p>
<h4 id="数据上传"><a href="#数据上传" class="headerlink" title="数据上传"></a>数据上传</h4><p>这里提供两种策略：</p>
<ul>
<li>流式上传（推荐）： 边录音边通过网络发送数据段。利用前文建立的 WebSocket 连接，将每个缓冲区的数据通过 esp_websocket_client_send_bin() 发给服务器。这样服务器可同步识别，不需等全部录完。这种方法实现对话响应更快。</li>
<li>后端上传（简单）： 先本地录完整句话，存成PCM或WAV格式，然后通过一次 HTTP POST 请求将音频文件发送给服务器，等待服务器返回结果。在初期调试时此方法更直观，但交互上会有一点延迟。</li>
</ul>
<p>我们以流式方式为例，展示录音与发送的伪代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设已经建立好 WebSocket 连接，句柄为 ws_client</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SAMPLE_RATE 16000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BYTES_PER_SAMPLE 2 <span class="comment">// 16-bit audio</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 512 <span class="comment">// 每次读取512字节（256个采样）</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> recording = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">on_wakeup_detected</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;唤醒词检测到！开始录音...\n&quot;</span>);</span><br><span class="line">    recording = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 可选：暂停WakeNet以节省CPU</span></span><br><span class="line">    disable_wakenet(sr_handle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">audio_record_task</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="type">char</span> mic_buffer[BUFFER_SIZE];</span><br><span class="line">    <span class="type">size_t</span> bytes_read = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> silence_count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> silence_threshold = <span class="number">5</span>; <span class="comment">// 连续静音块计数阈值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连续循环读取麦克风数据</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 阻塞读取一块音频数据</span></span><br><span class="line">        i2s_read(I2S_NUM_0, mic_buffer, BUFFER_SIZE, &amp;bytes_read, portMAX_DELAY);</span><br><span class="line">        <span class="keyword">if</span> (!recording) &#123;</span><br><span class="line">            <span class="keyword">continue</span>; <span class="comment">// 未触发录音就丢弃数据</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将读取的数据通过 WebSocket 发出</span></span><br><span class="line">        <span class="keyword">if</span> (bytes_read &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            esp_websocket_client_send_bin(ws_client, mic_buffer, bytes_read, portMAX_DELAY);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 简单静音检测：如果本次数据全是低幅值(接近静默)</span></span><br><span class="line">        <span class="type">bool</span> is_silence = check_silence(mic_buffer, bytes_read);</span><br><span class="line">        <span class="keyword">if</span> (is_silence) &#123;</span><br><span class="line">            silence_count++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            silence_count = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果连续多帧静默，认为讲话结束</span></span><br><span class="line">        <span class="keyword">if</span> (silence_count &gt; silence_threshold) &#123;</span><br><span class="line">            <span class="comment">// 发送特殊标志表示音频结束</span></span><br><span class="line">            esp_websocket_client_send_text(ws_client, <span class="string">&quot;&lt;end&gt;&quot;</span>, <span class="number">5</span>, portMAX_DELAY);</span><br><span class="line">            recording = <span class="literal">false</span>;</span><br><span class="line">            enable_wakenet(sr_handle); <span class="comment">// 重新启用唤醒监听</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;录音结束，等待回复...\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中，audio_record_task 会一直运行：平时 recording 标志为 false 时读入的数据直接丢弃（或可缓冲覆盖）；当唤醒发生时回调将 recording 置为 true，于是任务开始真正处理音频数据。</p>
<p>通过 i2s_read 从 I2S采集 BUFFER_SIZE 字节音频，每采集到一块，就用 esp_websocket_client_send_bin 发送二进制数据帧给服务器。这里假定已在别处初始化了 WebSocket 客户端 ws_client 并连接到服务器地址（例如 ws:&#x2F;&#x2F;&lt;服务器ip&gt;:&lt;端口&gt;）。ESP-IDF 的 WebSocket 客户端是线程安全的，可直接从任务中调用发送函数。</p>
<p>check_silence 是用户定义的函数，用于检查缓冲中是否绝大部分样本都接近零（可设定一个幅值阈值）。如果连续检测到若干帧静音，我们就认为用户停止了讲话。这时通过发送一条特殊的文本帧 “” 通知服务器音频流结束，然后把 recording 置回 false，表示本轮录音完成。还调用 enable_wakenet 恢复唤醒词检测，让设备准备接受下一次唤醒。</p>
<p>注意： 上述实现相对简单，实际应用中可能需要更健壮的 VAD 算法来准确判断讲话结束。另外，为了防止用户长时间讲话导致数据过多，可以设置最大录制时长，到点后强制结束。本示例省略了错误处理和资源管理（例如在结束录音后可能需要关闭I2S或重置缓冲等）。</p>
<h3 id="4-3-与云端模型的交互并返回文本"><a href="#4-3-与云端模型的交互并返回文本" class="headerlink" title="4.3 与云端模型的交互并返回文本"></a>4.3 与云端模型的交互并返回文本</h3><p>当 ESP32 将语音数据发送到服务器后，接下来就轮到服务器端进行处理：把音频转成文本，交给大模型生成回复，再将回复发送回来。因此 ESP32 需要能接收服务器的响应数据。在流式方案中，服务器可能通过 WebSocket 发回文本回复；在简单HTTP方案中，则是 ESP32 主动请求获取结果。我们这里以 WebSocket 双工通信为例说明。</p>
<p>ESP-IDF 的 WebSocket 客户端支持接收服务器推送的消息。可以注册回调或在循环中使用 esp_websocket_client_receive 来获取数据。在本例中，我们假定服务器最终发送回来的内容是纯文本的对话回复（或者为了简便，也可以让服务器直接返回语音合成后的 MP3 URL 等，但初期我们用文本即可）。ESP32 收到文本后，需要在本地加以处理，如在串口打印或者显示在屏幕上，或者通过TTS播放出来。</p>
<p>以下是接收回复并处理的示例代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 简单起见，在主任务里轮询接收服务器消息</span></span><br><span class="line"><span class="type">char</span> recv_buf[<span class="number">256</span>];</span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="type">int32_t</span> rlen = esp_websocket_client_receive(ws_client, recv_buf, <span class="keyword">sizeof</span>(recv_buf) - <span class="number">1</span>, portMAX_DELAY);</span><br><span class="line">    <span class="keyword">if</span> (rlen &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        recv_buf[rlen] = <span class="number">0</span>; <span class="comment">// 以NULL结尾形成字符串</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(recv_buf, <span class="string">&quot;&lt;ack&gt;&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 服务器确认收到音频的应答，可忽略或用于统计</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;云端回复: %s\n&quot;</span>, recv_buf);</span><br><span class="line">        <span class="comment">// 将回复显示到OLED屏幕（伪函数）</span></span><br><span class="line">        display_text_on_screen(recv_buf);</span><br><span class="line">        <span class="comment">// 可选：调用本地TTS播放语音（此处省略）</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个循环会一直等待 WebSocket 的消息。esp_websocket_client_receive 阻塞等待服务器发送的数据。收到后，我们检查内容：如果是预定义的控制消息（例如这里假设服务器可能发 “” 表示收到结束标志），那么不做处理；否则将其作为正常回复文本处理。通过串口打印出回复，并调用一个假定的 display_text_on_screen 函数在OLED上显示该文字。实际实现中，您需要用相应的屏幕驱动 API 将文字绘制出来（如使用 SSD1306 驱动或 LVGL 库）。</p>
<p>如果您希望机器人语音回答，可以在ESP32上集成一个简单的本地TTS（ESP-SR 框架本身带有简易的中文语音合成功能）或让服务器直接返回合成后的语音（例如 MP3 文件 URL 或音频流）。初始阶段为了专注核心，我们先不处理TTS。</p>
<p>至此，ESP32 端的主要代码逻辑已经完整：等待唤醒→录音上传→接收回复→输出结果→循环等待下一次唤醒。接下来，我们看看云端服务器该如何部署大模型来配合工作。</p>
<hr>
<h2 id="5-云端部署"><a href="#5-云端部署" class="headerlink" title="5. 云端部署"></a>5. 云端部署</h2><p>云端（或本地PC服务器）在整个系统中承担了重型AI计算的任务，包括语音识别和对话生成。根据硬件条件和需求，您可以选择自建服务器或使用云服务。本节将介绍如何连接大语言模型，以及如何搭建服务器端程序来实现智能对话。</p>
<h3 id="连接大语言模型-DeepSeek-Qwen-等"><a href="#连接大语言模型-DeepSeek-Qwen-等" class="headerlink" title="连接大语言模型 (DeepSeek&#x2F;Qwen 等)"></a>连接大语言模型 (DeepSeek&#x2F;Qwen 等)</h3><p>大语言模型的选择取决于您的资源。对于中文对话，比较好的开源选择有阿里巴巴的通义千问系列(Qwen)和衍生的DeepSeek模型。如果有足够算力，您可以在服务器上直接运行开源模型实例。例如，使用 Hugging Face Transformers 加载 DeepSeek-R1 Distill (基于 Qwen-7B) 模型，然后在本地执行推理。伪代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoModelForCausalLM, AutoTokenizer</span><br><span class="line"></span><br><span class="line">tokenizer = AutoTokenizer.from_pretrained(<span class="string">&quot;deepseek-ai/DeepSeek-R1-Distill-Qwen-7B&quot;</span>)</span><br><span class="line">model = AutoModelForCausalLM.from_pretrained(<span class="string">&quot;deepseek-ai/DeepSeek-R1-Distill-Qwen-7B&quot;</span>, device_map=<span class="string">&quot;auto&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设已经得到用户输入文本 user_text</span></span><br><span class="line">input_ids = tokenizer.encode(user_text, return_tensors=<span class="string">&quot;pt&quot;</span>)</span><br><span class="line">output_ids = model.generate(input_ids, max_length=<span class="number">200</span>)</span><br><span class="line">response_text = tokenizer.decode(output_ids[<span class="number">0</span>], skip_special_tokens=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>上述代码会生成 response_text 作为回复。但需要注意，这对7B模型至少需要十几GB显存或使用CPU耗时较长，因此如果硬件有限，不妨考虑调用在线API服务。</p>
<p>另一种便利的方法是使用模型提供方的云API：例如阿里云的通义千问提供了 DashScope API，可以直接通过 HTTP 请求获得回复，无需本地运行模型。您只需在阿里云申请 API Key，然后按照文档构造请求（通常是一个包含会话历史的 JSON）。以下是使用 DashScope SDK 的伪代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dashscope <span class="keyword">import</span> Completion</span><br><span class="line"></span><br><span class="line">Completion.api_key = <span class="string">&quot;&lt;你的通义api key&gt;&quot;</span></span><br><span class="line">response = Completion.create(prompt=user_text, model=<span class="string">&quot;qwen-plus&quot;</span>)</span><br><span class="line">answer_text = response.completions[<span class="number">0</span>].text</span><br></pre></td></tr></table></figure>

<p>利用在线大模型服务的优势是省去了部署模型的麻烦，而且一般响应速度快、效果好。不过要考虑到接口的使用费用或调用频率限制。</p>
<p>无论采用哪种方式获取对话回复，都应该注意实现上下文管理：即让模型记住之前的对话历史，从而实现连贯的多轮对话。这可以通过每次调用API时在 prompt 中附带前文对话，或使用模型的对话模式接口来实现。在DeepSeek&#x2F;通义这样的模型中，一般支持多轮对话，只需将历史问答拼接即可（或在 API 参数中传递 conversation_id 等）。</p>
<h3 id="调用语音识别-API"><a href="#调用语音识别-API" class="headerlink" title="调用语音识别 API"></a>调用语音识别 API</h3><p>在让大模型理解用户意图之前，我们需要将音频转成文字。这里我们使用之前准备好的 SenseVoice 模型服务。假设您已在服务器上运行了 SenseVoice 的 API（例如本地 FastAPI 服务，端点URL为 &#x2F;asr），ESP32 发送的音频通过 WebSocket 或 HTTP 转发给该服务进行识别。</p>
<p>如果采用我们上节的WebSocket方案，服务器可以在收到 ESP32 的音频帧后，将其拼接或直接送入语音识别引擎进行流式识别。阿里的 SenseVoice 支持长语音转写和多语言，可以逐步输出转写结果。简化流程如下：</p>
<ol>
<li>服务器收到音频数据帧，缓存至音频缓冲区。如果检测到结束标志””，则将缓冲区音频送入 ASR 引擎。</li>
<li>获取到完整的转写文本 user_text。</li>
<li>调用大模型生成 answer_text。</li>
<li>通过 WebSocket 将 answer_text 发回 ESP32。</li>
</ol>
<p>在实现中，可将步骤1-4集成在服务器的一个事件循环或多线程处理里。您也可以选择不等音频结束就边识别边生成，但那会复杂许多（需要分段、多段上下文管理，这里不深入）。</p>
<h3 id="服务器端搭建-AI-服务"><a href="#服务器端搭建-AI-服务" class="headerlink" title="服务器端搭建 AI 服务"></a>服务器端搭建 AI 服务</h3><p>您可以用任意擅长的语言编写服务器。例如，用 Python 的 websockets 库搭建 WebSocket 服务，收到二进制音频后调用 Python 接口处理。这需要加载 SenseVoice 模型和大模型，可能耗时，建议在服务器启动时就加载好模型到内存，避免每次请求重复初始化。以下是服务器伪代码框架（Python）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio, websockets</span><br><span class="line"><span class="keyword">from</span> sensevoice <span class="keyword">import</span> ASRModel <span class="comment"># 假设封装好的识别类</span></span><br><span class="line"><span class="keyword">from</span> your_llm_api <span class="keyword">import</span> LLMAPI <span class="comment"># 假设封装的大模型调用</span></span><br><span class="line"></span><br><span class="line">asr_model = ASRModel.load(<span class="string">&quot;SenseVoiceSmall&quot;</span>) <span class="comment"># 加载识别模型</span></span><br><span class="line">llm_api = LLMAPI(api_key=<span class="string">&quot;...&quot;</span>) <span class="comment"># 初始化大模型API</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handle_client</span>(<span class="params">websocket, path</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;客户端已连接&quot;</span>)</span><br><span class="line">    audio_bytes = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> message <span class="keyword">in</span> websocket:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(message, <span class="built_in">bytes</span>):</span><br><span class="line">            <span class="comment"># 累积音频数据</span></span><br><span class="line">            audio_bytes += message</span><br><span class="line">        <span class="keyword">elif</span> message == <span class="string">&quot;&lt;end&gt;&quot;</span>:</span><br><span class="line">            <span class="comment"># 收到音频结束</span></span><br><span class="line">            user_text = asr_model.transcribe(audio_bytes) <span class="comment"># 语音转文本</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;识别结果:&quot;</span>, user_text)</span><br><span class="line">            answer = llm_api.ask(user_text) <span class="comment"># 调用大模型获取回复</span></span><br><span class="line">            <span class="keyword">await</span> websocket.send(answer) <span class="comment"># 发送回复给ESP32</span></span><br><span class="line">            audio_bytes = <span class="string">b&quot;&quot;</span> <span class="comment"># 清空缓冲，准备下一次对话</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 处理其他控制消息，例如心跳/确认</span></span><br><span class="line">            <span class="keyword">await</span> websocket.send(<span class="string">&quot;&lt;ack&gt;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这个简化的服务器逻辑中，我们使用 async for 来持续监听来自某个客户端(ESP32)的消息。如果收到的是二进制数据，则累加到 audio_bytes 缓冲。如果收到文本 “” 则表示一段语音结束，遂调用 ASR 将整个音频转为文字，然后把文字传给大模型接口获得回复，最后通过 websocket.send 将回复发回客户端。然后清空缓冲等待下一轮交流。这里还示范了收&#x2F;发 “” 之类的控制信息的处理。实际应用中，应考虑异常处理（如网络中断）、识别超时等情况。</p>
<p>通过上述服务器的配合，我们的 ESP32 语音机器人基本功能就完成了：当你对着麦克风说“小智小智”（假定这是唤醒词），ESP32 检测到后开始录音，并把你的话通过网络发送出去；服务器将你的语音识别为文字，再由大模型生成回答“好的，我在呢”（示例），服务器将回答发送回 ESP32；ESP32 接收到后在屏幕上显示出来，并通过扬声器播报出来。整个过程接近实时，并且可以多次轮询，实现连续对话。</p>
<hr>
<h2 id="6-优化与扩展"><a href="#6-优化与扩展" class="headerlink" title="6. 优化与扩展"></a>6. 优化与扩展</h2><p>在基本功能实现后，我们可以对“小智”机器人进行多方面的优化和扩展，以提升体验和性能：</p>
<h3 id="提升本地计算能力"><a href="#提升本地计算能力" class="headerlink" title="提升本地计算能力"></a>提升本地计算能力</h3><p>虽然 ESP32 性能有限，但我们可以通过一些技巧优化运行效率。例如，使用缓存机制：针对用户经常询问的问题，可以在ESP32端缓存上一次的回答，若短时间内再次询问相同问题，可以直接回复缓存结果而不必每次都请求云端，从而降低延迟和流量。另外，尽量利用好 ESP32-S3 的硬件加速功能，如采用定点运算或使用 ESP-DSP 库优化音频处理。对于云端的大模型，可以考虑模型蒸馏或量化来加快推理速度。例如将原本大的模型压缩为更小的参数，这也是 DeepSeek 提供蒸馏模型的思路。量化后的模型（如 INT8&#x2F;INT4）在GPU甚至CPU上的推理速度会有明显提升，使对话响应更快。同时可在服务器端对相似的问答进行缓存，减少重复计算。</p>
<h3 id="增强离线功能"><a href="#增强离线功能" class="headerlink" title="增强离线功能"></a>增强离线功能</h3><p>目前我们的机器人主要依赖云端AI，但是我们可以赋予它一定的脱机能力。首先，ESP32 上的 MultiNet 命令词识别模块可以识别一些常用指令词离线运行。我们可以预先定义一组本地指令（例如：“播放音乐”、“停止”、“音量大一点”等）并训练相应模型烧录进ESP32。这使得即使断网，机器人也能执行简单指令控制。此外，可以加入简单的本地问答库或规则，例如对于固定的问题（天气、时间）在ESP32存储预设答案，这样在无网络时也能回答部分问题。更高级的，可以在ESP32上运行一个超小型的语言模型（例如基于 Edge Impulse 或 GPT2-tiny 等），用于应对非常简短的对话。不过由于设备限制，这类模型智能性有限，主要作为备份。在应用中，可以设置策略：优先调用云端AI，若不可用则退而求其次使用本地能力应答。</p>
<h3 id="显示屏交互扩展"><a href="#显示屏交互扩展" class="headerlink" title="显示屏交互扩展"></a>显示屏交互扩展</h3><p>为了让“小智”更生动，我们可以充分利用 OLED&#x2F;LCD 显示屏来丰富人机界面。例如，在屏幕上显示对话文字的同时，可以加入表情或头像来指示机器人状态：听的时候显示“耳朵”图标，思考时显示“加载中”动画，说话时显示“嘴巴”或表情变化等。如果使用的是彩色屏幕，可以绘制一个卡通头像，小智在不同状态下的表情（睁眼&#x2F;闭眼&#x2F;说话）变化，从而使机器人更具亲和力。技术实现上，可以预先加载几张位图或者使用简单的绘图指令组合出表情。在 ESP-IDF 中可以结合 LVGL 图形库实现精美的 UI 界面，包括文本、图像和动画效果。触摸屏设备还可以扩展触控功能，例如加一个“对话历史”查看或功能菜单。除了屏幕，您还可以增添LED指示灯（比如 RGB LED 显示不同颜色代表正在录音或思考）或者蜂鸣器音效提示用户进行交互提示。</p>
<h3 id="语音合成输出"><a href="#语音合成输出" class="headerlink" title="语音合成输出"></a>语音合成输出</h3><p>虽然本教程侧重文字输出，但让机器人“开口说话”无疑会提供更直观的互动。在 ESP32 上实现文本转语音(TTS)有几种方案：可以利用 ESP-SR 自带的简易 TTS 模块生成中文语音；或者占用稍多资源，集成一个轻量级的 TTS 引擎（如科大讯飞离线TTS SDK，不过对Flash和RAM要求较高）；再或者走云端，由服务器把回复文本经过 TTS 合成后，以音频文件发送给 ESP32 播放。最后一种方式对ESP32 压力最小，只需接收和播放音频即可。在具体实现时，可以在服务器端调用诸如阿里云易音识别、微软Azure TTS等云服务，将回答文本转为语音，然后ESP32通过HTTP获取 MP3文件，使用集成的音频解码器播放。若追求本地纯离线，也可考虑安装一个小型MP3解码库，将服务器传来的MP3数据用 ESP32 解码输出至扬声器（ESP32有足够能力播放中等码率的MP3）。语音合成的声音可以自定义，让小智有独特的音色。</p>
<h3 id="其他扩展创意"><a href="#其他扩展创意" class="headerlink" title="其他扩展创意"></a>其他扩展创意</h3><p>小智机器人可以结合更多传感器和功能模块，实现丰富的玩法。例如，加入摄像头模块（ESP32-S3支持连接摄像头），配合云端的视觉识别，实现看图对话或人脸识别后的个性化对话；或者集成舵机作为“头部”，让机器人朝向发声方向转动；添加触摸传感器或按钮，让用户可以用触摸来激活对话等。此外，如果追求更强的AI本地能力，可以关注乐鑫新推出的 ESP32-P4 等更高性能芯片或者结合Edge AI加速器来运行部分模型。对于软件层面，也可以将当前方案与其他开源框架集成，例如接入 Home Assistant 平台，实现家居语音控制；或使用 LangChain 框架设计机器人的对话流程和工具调用能力，让小智不仅能聊天，还能帮忙查询资料、控制设备。</p>
<p>通过以上优化，小智 AI 机器人将变得更加实用和智能：在联网时，它是一个功能全面的语音助手，能聊天、查信息、控制家电；离线时，它仍具备基本的指令识别和交流能力。不仅如此，借助ESP32的开源生态，您可以不断为小智添加新功能。在实践过程中，请充分利用社区资源：参考官方示例、查看类似项目源码，这将有助于您更深入地理解实现细节并排除开发中的困难。</p>
<hr>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>恭喜您完成这个从无到有的项目！通过本教程，我们学习了 ESP32 上语音唤醒的原理，搭建了语音对话硬件平台，编写了嵌入式代码将语音与云端AI连接，并了解了如何部署强大的大模型服务来实现智能对答。对于初学者来说，这是迈向物联网 AI 世界的重要一步。当然，受限于时间和篇幅，教程中的很多模块都是简化的，但希望这份详细指南为您理清了思路。在实际开发中，您可能会遇到各种挑战，比如噪声环境下识别率、网络延迟导致的响应速度、不同模块兼容性等，不要气馁，多查阅资料、多尝试调优。借助开源社区的力量，您的“小智”一定可以变得越来越聪明。期待您为它赋予更多有趣的技能！祝您玩得开心，在 AI 创作的道路上不断进步。</p>
<hr>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li>Espressif Systems, ESP-SR 开源语音识别框架 – 模块组成及功能</li>
<li>RoboticsCV, 嵌入式设备语音唤醒和识别原理 – ESP32-S3 AI指令和 PSRAM 优势</li>
<li>Espressif GitHub, ESP-BOX 技术架构 – WakeNet 唤醒词模型工作机制</li>
<li>Fabrik, ESP32 实时语音助手项目 – WebSocket 音频流传输架构</li>
<li>Hacker News, 本地 LLM 语音助手实现讨论 – ESP32 建立 WebSocket 及音频传输流程</li>
<li>Hacker News, ESP32 语音硬件建议 – 优选 I2S 数字麦克风避免模拟麦克风噪声</li>
<li>CSDN 博客, ESP-Skainet 语音唤醒教程 – ESP32 上唤醒词和命令词识别案例</li>
<li>阿里达摩院, SenseVoice 开源项目 – 多语言语音识别模型简介及能力</li>
<li>DeepSeek 项目说明 – 开源大型语言模型性能及开放版本</li>
<li>VocaMirror 开源项目 – 通义千问(Qwen) API 使用示例</li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/up.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/up.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">周言志</div><div class="post-copyright__author_desc">欢迎来到我的世界</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2025/04/12/25-4-12ai%E5%B0%8F%E6%99%BA/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2025/04/12/25-4-12ai%E5%B0%8F%E6%99%BA/')">DIY电子女友小智</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/img/wx.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/wx.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/null" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/null" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">首页</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/AI/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>AI<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/ESP32/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>ESP32<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/%E8%AF%AD%E9%9F%B3%E5%8A%A9%E6%89%8B/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>语音助手<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2024/12/29/677157e51a575.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/04/07/25-4-7Office-WPS%E4%B8%8B%E8%BD%BD/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/04/07/67f3bef8d9b98.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Office/WPS下载</div></div></a></div><div class="next-post pull-right"><a href="/2025/05/10/25-5-10Hexo%E5%8D%9A%E5%AE%A2%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/12/29/677157e51a575.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Hexo 博客性能优化指南</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-switch"><span class="first-comment">Twikoo</span><span id="switch-btn"></span><span class="second-comment">Waline</span></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div><div><div id="waline-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/up.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">周言志</h1><div class="author-info__desc">欢迎来到我的世界</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/anzhiyu-c" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/1803174585" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%99%E7%A8%8B%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">教程目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">1. 基础原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ESP32-%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%85%B6%E5%9C%A8-AI-%E9%A2%86%E5%9F%9F%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">ESP32 架构及其在 AI 领域的应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E9%9F%B3%E5%94%A4%E9%86%92%E6%A8%A1%E5%9D%97%EF%BC%88ESP-SR%EF%BC%89%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.2.</span> <span class="toc-text">语音唤醒模块（ESP-SR）的工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E5%AF%B9%E8%AF%9D%E7%9A%84%E6%A6%82%E5%BF%B5%E5%8F%8A-WebSocket-UDP-%E4%BC%A0%E8%BE%93%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.3.</span> <span class="toc-text">流式对话的概念及 WebSocket&#x2F;UDP 传输机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#WebSocket-%E9%80%9A%E4%BF%A1"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">WebSocket 通信</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UDP-%E4%BC%A0%E8%BE%93"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">UDP 传输</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%A1%AC%E4%BB%B6%E5%87%86%E5%A4%87"><span class="toc-number">1.3.</span> <span class="toc-text">2. 硬件准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ESP32-S3-%E5%BC%80%E5%8F%91%E6%9D%BF%EF%BC%88%E5%B8%A6%E6%9C%89-PSRAM%EF%BC%89"><span class="toc-number">1.3.1.</span> <span class="toc-text">ESP32-S3 开发板（带有 PSRAM）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BA%A6%E5%85%8B%E9%A3%8E"><span class="toc-number">1.3.2.</span> <span class="toc-text">麦克风</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%AC%E5%A3%B0%E5%99%A8%E5%92%8C%E9%9F%B3%E9%A2%91%E6%94%BE%E5%A4%A7%E5%99%A8%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-number">1.3.3.</span> <span class="toc-text">扬声器和音频放大器（可选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E5%B1%8F%EF%BC%88OLED-LCD%EF%BC%8C%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-number">1.3.4.</span> <span class="toc-text">显示屏（OLED&#x2F;LCD，可选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E9%85%8D%E4%BB%B6"><span class="toc-number">1.3.5.</span> <span class="toc-text">其他配件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E8%B4%AD%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.3.6.</span> <span class="toc-text">选购建议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%BD%AF%E4%BB%B6%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.4.</span> <span class="toc-text">3. 软件环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-ESP-IDF-%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6"><span class="toc-number">1.4.1.</span> <span class="toc-text">安装 ESP-IDF 开发框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-VSCode-Cursor-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">1.4.2.</span> <span class="toc-text">配置 VSCode&#x2F;Cursor 开发环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%89%80%E9%9C%80%E5%BA%93%E5%92%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">1.4.3.</span> <span class="toc-text">安装所需库和工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.</span> <span class="toc-text">4. 代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%AF%AD%E9%9F%B3%E5%94%A4%E9%86%92%E5%8A%9F%E8%83%BD"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 初始化语音唤醒功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%A4%84%E7%90%86%E8%AF%AD%E9%9F%B3%E8%BE%93%E5%85%A5%E5%B9%B6%E4%B8%8A%E4%BC%A0%E8%87%B3%E5%A4%A7%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 处理语音输入并上传至大模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9F%B3%E9%A2%91%E9%87%87%E9%9B%86"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">音频采集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">数据上传</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E4%B8%8E%E4%BA%91%E7%AB%AF%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%BA%A4%E4%BA%92%E5%B9%B6%E8%BF%94%E5%9B%9E%E6%96%87%E6%9C%AC"><span class="toc-number">1.5.3.</span> <span class="toc-text">4.3 与云端模型的交互并返回文本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E4%BA%91%E7%AB%AF%E9%83%A8%E7%BD%B2"><span class="toc-number">1.6.</span> <span class="toc-text">5. 云端部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B-DeepSeek-Qwen-%E7%AD%89"><span class="toc-number">1.6.1.</span> <span class="toc-text">连接大语言模型 (DeepSeek&#x2F;Qwen 等)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB-API"><span class="toc-number">1.6.2.</span> <span class="toc-text">调用语音识别 API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%90%AD%E5%BB%BA-AI-%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.6.3.</span> <span class="toc-text">服务器端搭建 AI 服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E4%BC%98%E5%8C%96%E4%B8%8E%E6%89%A9%E5%B1%95"><span class="toc-number">1.7.</span> <span class="toc-text">6. 优化与扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8D%87%E6%9C%AC%E5%9C%B0%E8%AE%A1%E7%AE%97%E8%83%BD%E5%8A%9B"><span class="toc-number">1.7.1.</span> <span class="toc-text">提升本地计算能力</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E5%BC%BA%E7%A6%BB%E7%BA%BF%E5%8A%9F%E8%83%BD"><span class="toc-number">1.7.2.</span> <span class="toc-text">增强离线功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E5%B1%8F%E4%BA%A4%E4%BA%92%E6%89%A9%E5%B1%95"><span class="toc-number">1.7.3.</span> <span class="toc-text">显示屏交互扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E9%9F%B3%E5%90%88%E6%88%90%E8%BE%93%E5%87%BA"><span class="toc-number">1.7.4.</span> <span class="toc-text">语音合成输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%89%A9%E5%B1%95%E5%88%9B%E6%84%8F"><span class="toc-number">1.7.5.</span> <span class="toc-text">其他扩展创意</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-number">1.8.</span> <span class="toc-text">结语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">1.9.</span> <span class="toc-text">参考文献</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/05/10/25-5-10Hexo%E5%8D%9A%E5%AE%A2%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97/" title="Hexo 博客性能优化指南"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2024/12/29/677157e51a575.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Hexo 博客性能优化指南"/></a><div class="content"><a class="title" href="/2025/05/10/25-5-10Hexo%E5%8D%9A%E5%AE%A2%E4%BC%98%E5%8C%96%E6%8C%87%E5%8D%97/" title="Hexo 博客性能优化指南">Hexo 博客性能优化指南</a><time datetime="2025-05-10T05:46:58.000Z" title="发表于 2025-05-10 13:46:58">2025-05-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/12/25-4-12ai%E5%B0%8F%E6%99%BA/" title="DIY电子女友小智"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/04/13/67fa94a426f38.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DIY电子女友小智"/></a><div class="content"><a class="title" href="/2025/04/12/25-4-12ai%E5%B0%8F%E6%99%BA/" title="DIY电子女友小智">DIY电子女友小智</a><time datetime="2025-04-12T15:53:33.000Z" title="发表于 2025-04-12 23:53:33">2025-04-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/07/25-4-7Office-WPS%E4%B8%8B%E8%BD%BD/" title="Office/WPS下载"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/04/07/67f3bef8d9b98.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Office/WPS下载"/></a><div class="content"><a class="title" href="/2025/04/07/25-4-7Office-WPS%E4%B8%8B%E8%BD%BD/" title="Office/WPS下载">Office/WPS下载</a><time datetime="2025-04-07T12:14:58.000Z" title="发表于 2025-04-07 20:14:58">2025-04-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/07/25-4-7Windows%E7%B3%BB%E7%BB%9F%E4%B8%8B%E8%BD%BD%E4%BB%93%E5%82%A8%E7%AB%99/" title="Windows系统下载仓储站"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/04/03/67ee4ac70af60.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Windows系统下载仓储站"/></a><div class="content"><a class="title" href="/2025/04/07/25-4-7Windows%E7%B3%BB%E7%BB%9F%E4%B8%8B%E8%BD%BD%E4%BB%93%E5%82%A8%E7%AB%99/" title="Windows系统下载仓储站">Windows系统下载仓储站</a><time datetime="2025-04-07T11:37:30.000Z" title="发表于 2025-04-07 19:37:30">2025-04-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/03/25-4-3%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E8%81%9A%E5%90%88/" title="如何配置端口聚合"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2025/04/01/67eb5ec3bf0ff.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="如何配置端口聚合"/></a><div class="content"><a class="title" href="/2025/04/03/25-4-3%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E8%81%9A%E5%90%88/" title="如何配置端口聚合">如何配置端口聚合</a><time datetime="2025-04-03T07:06:15.000Z" title="发表于 2025-04-03 15:06:15">2025-04-03</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><div id="runtimeTextTip"></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2024 - 2025 By <a class="footer-bar-link" href="/" title="周言志" target="_blank">周言志</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">20</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">45</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">10</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">关注我</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://github.com/tenxiaodao/tenxiaodao.github.io" title="Github"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/up.jpg" alt="Github"/><span class="back-menu-item-text">Github</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://space.bilibili.com/1803174585" title="Bilibili"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/up.jpg" alt="Bilibili"/><span class="back-menu-item-text">Bilibili</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">网盘</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://pan.quark.cn/s/c98d1ceee692" title="软件/工具"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="软件/工具"/><span class="back-menu-item-text">软件/工具</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=13738866688&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 小空调</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size: 0.88rem;">AI<sup>1</sup></a><a href="/tags/ARP/" style="font-size: 0.88rem;">ARP<sup>1</sup></a><a href="/tags/CasaOS/" style="font-size: 0.88rem;">CasaOS<sup>1</sup></a><a href="/tags/Docker/" style="font-size: 0.88rem;">Docker<sup>1</sup></a><a href="/tags/ESP32/" style="font-size: 0.88rem;">ESP32<sup>1</sup></a><a href="/tags/GitHub-Pages/" style="font-size: 0.88rem;">GitHub Pages<sup>1</sup></a><a href="/tags/Hexo/" style="font-size: 0.88rem;">Hexo<sup>6</sup></a><a href="/tags/KVM/" style="font-size: 0.88rem;">KVM<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>2</sup></a><a href="/tags/Markdown/" style="font-size: 0.88rem;">Markdown<sup>2</sup></a><a href="/tags/NAS/" style="font-size: 0.88rem;">NAS<sup>1</sup></a><a href="/tags/Node-js/" style="font-size: 0.88rem;">Node.js<sup>1</sup></a><a href="/tags/Python/" style="font-size: 0.88rem;">Python<sup>3</sup></a><a href="/tags/Scrapy/" style="font-size: 0.88rem;">Scrapy<sup>2</sup></a><a href="/tags/TCP/" style="font-size: 0.88rem;">TCP<sup>1</sup></a><a href="/tags/UDP/" style="font-size: 0.88rem;">UDP<sup>1</sup></a><a href="/tags/Ubuntu/" style="font-size: 0.88rem;">Ubuntu<sup>1</sup></a><a href="/tags/WSL2/" style="font-size: 0.88rem;">WSL2<sup>1</sup></a><a href="/tags/Windows/" style="font-size: 0.88rem;">Windows<sup>2</sup></a><a href="/tags/macOS/" style="font-size: 0.88rem;">macOS<sup>1</sup></a><a href="/tags/office/" style="font-size: 0.88rem;">office<sup>1</sup></a><a href="/tags/windows%E9%95%9C%E5%83%8F/" style="font-size: 0.88rem;">windows镜像<sup>1</sup></a><a href="/tags/%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" style="font-size: 0.88rem;">个人博客<sup>1</sup></a><a href="/tags/%E4%B8%BB%E9%A2%98%E9%85%8D%E7%BD%AE/" style="font-size: 0.88rem;">主题配置<sup>1</sup></a><a href="/tags/%E4%BA%A4%E6%8D%A2%E6%9C%BA/" style="font-size: 0.88rem;">交换机<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">前端开发<sup>2</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD/" style="font-size: 0.88rem;">前端性能<sup>1</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2%E4%BC%98%E5%8C%96/" style="font-size: 0.88rem;">博客优化<sup>1</sup></a><a href="/tags/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" style="font-size: 0.88rem;">博客搭建<sup>4</sup></a><a href="/tags/%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/" style="font-size: 0.88rem;">压力测试<sup>1</sup></a><a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 0.88rem;">爬虫<sup>2</sup></a><a href="/tags/%E7%8E%A9%E5%AE%A2%E4%BA%91/" style="font-size: 0.88rem;">玩客云<sup>1</sup></a><a href="/tags/%E7%AB%AF%E5%8F%A3%E8%81%9A%E5%90%88/" style="font-size: 0.88rem;">端口聚合<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%AB%99%E6%90%AD%E5%BB%BA/" style="font-size: 0.88rem;">网站搭建<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96/" style="font-size: 0.88rem;">网络优化<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" style="font-size: 0.88rem;">网络协议<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">网络安全<sup>2</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E6%8A%80%E6%9C%AF/" style="font-size: 0.88rem;">网络技术<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/" style="font-size: 0.88rem;">网络配置<sup>1</sup></a><a href="/tags/%E8%AF%AD%E9%9F%B3%E5%8A%A9%E6%89%8B/" style="font-size: 0.88rem;">语音助手<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/3251973470&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("08/31/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2024 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 周言志 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("08/31/2024 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "";
        img.title = "下班了就该开开心心的玩耍，嘿嘿~";
        img.alt = "下班了就该开开心心的玩耍，嘿嘿~";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://yuhaozhe-twikoo.hf.space',
      region: 'ap-shanghai',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://yuhaozhe-twikoo.hf.space',
      region: 'ap-shanghai',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><script>(() => {
  const initWaline = () => {
    const waline = Waline.init(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline-test-54hthgju8-yuhaozhes-projects.vercel.app/',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: true,
    }, null))
  }

  const loadWaline = async () => {
    if (typeof Waline === 'object') initWaline()
    else {
      await getCSS('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.css')
      await getScript('https://cdn.cbd.int/@waline/client@2.15.5/dist/waline.js')
      initWaline()
    }
  }

  if ('Twikoo' === 'Waline' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://yuhaozhe-twikoo.hf.space',
        region: 'ap-shanghai',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script id="click-heart" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="async" mobile="true"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>